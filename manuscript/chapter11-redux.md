# Аутентификация пользователя с помощью `Django-Registration-Redux` {#chapter-redux}
В [предыдущей главе](#chapter-user), мы добавили функции для входа в систему и регистрации, вручную создавая URL-адреса, представления и шаблоны. Однако эти функции являются часто используемыми во многих веб-приложений, поэтому разработчики создали множество дополнительных приложений, которые могут быть добавлены в Ваш Django проект, чтобы уменьшить количество кода, которое нужно будет написать самому для реализации: входа в систему, регистрации, однофакторной и двухфакторной аутентификации, изменения пароля, восстановления пароля и т. д. В этой главе мы изменим наш код для входа в систему и регистрации, чтобы он использовал пакет под названием `django-registration-redux`, предоставляющий эти возможности, а также много других.

Это означает, что нам нужно будет изменить наш код, удалив ранее созданные функции для входа в систему и регистрации, и затем настроить наш проект, добавив в него приложение `django-registration-redux`. В этой главе также будет показано как использовать внешние приложения и как Вы можете легко их подключить к Вашему Django проекту.

## Настраиваем Django Registration Redux
Для начала нам нужно установить `django-registration-redux` версии 2.2 в Вашу среду, используя `pip`.

{lang="text",linenos=off}
    pip install -U django-registration-redux==2.2

Теперь когда пакет установлен, нам нужно сообщить Django, что мы будем использовать это приложение. Откройте файл `settings.py` и обновите список `INSTALLED_APPS`:

{lang="python",linenos=off}
    INSTALLED_APPS = [
        'django.contrib.admin',
        'django.contrib.auth',
        'django.contrib.contenttypes',
        'django.contrib.sessions',
        'django.contrib.messages',
        'django.contrib.staticfiles',
        'rango',
        'registration'  # добавляем пакет для регистрации
        ]
    
Пока Вы находитесь в файле `settings.py`, Вы также можете добавить следующие переменные, которые позволяют настроить пакет для регистрации (назначение настроек должно быть понятно из их названия):

{lang="python",linenos=off}
    # Если равно True, то пользователи могут регистрироваться
    REGISTRATION_OPEN = True
    # Окно активации длиной в одну неделю; Вы, конечно, можете использовать другие значение.
    ACCOUNT_ACTIVATION_DAYS = 7
    # Если равно True, то пользователи будут автоматически входить в систему после регистрации.
    REGISTRATION_AUTO_LOGIN = True  
    # Страница, на которую пользователи будут попадать после успешного входа в систему
    LOGIN_REDIRECT_URL = '/rango/' 
    # Страница, на которую пользователи перенаправляются, если они не вошли в систему
    # и пытаютсяя получить доступ к страницам, требующим аутентификации
    LOGIN_URL = '/accounts/login/' 

В `tango_with_django_project/urls.py` теперь Вы можете добавить `urlpatterns`, добавив в него ссылку на пакет для регистрации:

{lang="python",linenos=off}
    path('accounts/', include('registration.backends.simple.urls')),

Пакет `django-registration-redux` предоставляет несколько различных бекендов для регистрации в зависимости от Ваших потребностей. Например, Вам может Вы можете захотеть использовать двухфакторный процесс, когда пользователю отправляется электронное письмо с ссылкой для подтверждения. Здесь мы будем использовать простой однофакторный процесс регистрации, когда пользователь создаёт свою учетную запись, вводя имя пользователя, адрес электронной почты, пароль и автоматически входит в систему.

## Функциональные возможности пакета и URL сопоставление
Пакет Django Registration Redux предоставляет множество функций. В файле `registration.backend.simple.urls` существуют следующие сопоставления:

- для регистрации -\> `/accounts/register/`
- для успешной регистрации -\> `/accounts/register/complete/`
- для входа в систему -\> `/accounts/login/`
- для выхода из системы -\> `/accounts/logout/`
- для изменения пароля -\> `/password/change/`
- для сброса пароля -\> `/password/reset/`

В то время как в `registration.backends.default.urls` он предоставляет функции для активации учетной записи в два этапа:

- активация выполнена успешно (используется при регистрации в два этапа) -\> `activate/complete/`
- активировать (используется, если выполнить действие для учетной записи не удалось) -\> `activate/<ключ_для_активации>/`
- электронное письмо для активации (уведомляет пользователя, что электронное письмо для активации было отправлено)

    > - тело письма для активации (текстовый файл, содержащий текст письма для активации)
    > - тема письма активации (текстовый файл, содержащий строку темы письма для активации)

В чем подвох. Хотя Django Registration Redux предоставляет все эти функции, он не предоставляет шаблоны, потому что они, как правило, зависят от приложения. Поэтому нам нужно создать шаблоны, связанные с каждым представлением.

## Настраиваем шаблоны
В [кратком руководстве по Django Registration Redux](https://django-registration-redux.readthedocs.org/en/latest/quickstart.html), рассматривается тема о том какие шаблоны необходимы, но не сразу понятно, что входит в каждый шаблон. Вместо того, чтобы пытаться разобраться в этом коде, мы можем взглянуть на набор [шаблонов, написанных Андерсом Хофстее (Anders Hofstee)](https://github.com/macdhuibh/django-registration-templates), чтобы быстро понять какой код нам нужно будет добавить вручную. 

Сначала создайте новый каталог в каталоге `templates` и назовите его `registration`. Здесь мы будем хранить все страницы, связанные с приложением Django Registration Redux, поскольку он будет искать в этом каталоге требуемые ему шаблоны.

### Шаблон для входа в систему {#section-redux-templates-login}
В `templates/registration` создайте файл `login.html` со следующим кодом:

{lang="html",linenos=off}
    {% extends "rango/base.html" %}
    {% block body_block %}
        <h1>Login</h1>
        <form method="post" action=".">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="submit" value="Log in" />
            <input type="hidden" name="next" value="{{ next }}" />
        </form>
        <p>
            Not a member? 
            <a href="{% url 'registration_register' %}">Register</a>
        </p>
    {% endblock %}

Обратите внимание, что для формирования URL-адреса используется тег шаблона `url`. Если Вы перейдете по адресу `http://127.0.0.1:8000/accounts/`, то увидите список URL сопоставлений и имена, связанные с каждым URL-адресом (если `DEBUG=True` в `settings.py`).

### Шаблон для регистрации
В `templates/registration` создайте файл `registration_form.html` со следующим кодом:

{lang="html",linenos=off}
    {% extends "rango/base.html" %}
    {% block body_block %}
        <h1>Register Here</h1>
        <form method="post" action=".">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="submit" value="Submit" />
        </form>
    {% endblock %}

### Шаблон для успешной регистрации
В `templates/registration` создайте файл `registration_complete.html` со следующим кодом:

{lang="html",linenos=off}
    {% extends "rango/base.html" %}
    {% block body_block %}
        <h1>Registration Complete</h1>
        <p>You are now registered</p>
    {% endblock %}

### Шаблон для выхода из системы
В `templates/registration` создайте файл `logout.html` со следующим кодом:

{lang="html",linenos=off}
    {% extends "rango/base.html" %}
    {% block body_block %}
        <h1>Logged Out</h1>
        <p>You are now logged out.</p>
    {% endblock %}
        
### Проверяем работу процесса регистрации
Сначала запустите `python manage.py migrate`, чтобы в базу данных попали обновления, требуемые для пакета `Django Registration Redux`. Затем запустите сервер и перейдите по адресу: <http://127.0.0.1:8000/accounts/register/>.

Обратите внимание, что форма регистрации содержит два поля для пароля - для проверки правильности его ввода. Попытайтесь зарегистрироваться, но введите разные пароли.

Если у Вас получилось зарегистрироваться, то значит что-то не подключено.

### Рефакторинг Вашего проекта
Теперь Вам нужно обновить `base.html`, добавив в него новые URL-адреса для регистрации.

- Измените ссылку на страницу регистрации, чтобы она указывала на `<a href="{% url 'registration_register' %}">`.
- Измените ссылку на страницу входа в систему, чтобы она указывала на `<a href="{% url 'auth_login' %}">`.
- Измените ссылку на страницу выхода из системы, чтобы она указывала на `<a href="{% url 'auth_logout' %}?next=/rango/">`.
- В файле `settings.py` обновите `LOGIN_URL`, задав новое значение `'/accounts/login/'`.

Обратите внимание, что в ссылку для выхода из системы мы добавили `?next=/rango/`. Это сделано для того, чтобы когда пользователь выходил из системы, его перенаправляло на главную страницу Rango. Если мы удалим её, то системы будет перенаправлять пользователей на страницу выхода из системы (что не очень хорошо).

Затем удалите функции `register`, `login`, `logout` из приложения `rango`, т. е. удалите URL-адреса, представления и шаблоны (или закомментируйте их).

### Изменяем последовательность действий при регистрации {#section-redux-templates-flow}
После того как пользователь зарегистрировался, он попадает на страницу успешного завершения регистрации. Такой подход является устаревшим; поэтому вместо этого мы можем перенаправить их на главную страницу. Это можно сделать, переопределив `RegistrationView`, предоставляемый `registration.backends.simple.views`. Обновите `tango_with_django_project/urls.py`, импортировав `RegistrationView` и добавив следующий класс для регистрации.

{lang="python",linenos=off}
    from registration.backends.simple.views import RegistrationView
    from django.urls import reverse
    
    # Создайте новый класс, который перенаправляет пользователя на главную страницу, 
    # после успешного входа в систему
    class MyRegistrationView(RegistrationView):
        def get_success_url(self, user):
            return reverse('index')

Затем обновите список `urlpatterns` в Вашем модуле `urls.py` Django проекта, добавив следующую строку перед шаблоном для `accounts`. Обратите внимание, что это *не* модуль `urls.py` в каталоге `rango`!

{lang="python",linenos=off}
    path('accounts/register/', 
        MyRegistrationView.as_view(), 
            name='registration_register'),

Таким образом совпадение для `accounts/register` будет найдено раньше, чем будут проверены другие URL-адреса, начинающиеся с `accounts/`. Таким образом, мы сможем перенаправить пользователя с `accounts/register` на наше измененное представление для регистрации.

X> ### Упражнения и подсказки
X> - Предоставьте пользователям возможность изменять пароль.
X> - Подсказка: просмотрите [шаблоны Андерса Хофстее (Anders Hofstee)](https://github.com/macdhuibh/django-registration-templates/tree/master/registration), чтобы понять с чего начать.
X> - Подсказка: URL-адрес для смены паролей - `accounts/password/change/`, а URL-адрес, сообщающий, что пароль был успешно изменен - `accounts/password/change/done/`.
